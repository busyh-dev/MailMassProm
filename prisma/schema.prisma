// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ===========================================
// USER MODEL - Utenti della piattaforma
// ===========================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relazioni
  campaigns     Campaign[]
  contacts      Contact[]
  templates     Template[]
  contactLists  ContactList[]
  automations   Automation[]
  webhooks      Webhook[]
  apiKeys       ApiKey[]

  @@map("users")
}

// ===========================================
// CONTACT MODEL - Lista contatti email
// ===========================================

model Contact {
  id          String        @id @default(cuid())
  email       String
  name        String?
  firstName   String?
  lastName    String?
  phone       String?
  company     String?
  position    String?
  status      ContactStatus @default(ACTIVE)
  tags        String        @default("[]")
  customFields String?      @default("{}")
  
  // Statistiche
  totalEmailsReceived Int @default(0)
  totalOpened        Int @default(0)
  totalClicked       Int @default(0)
  lastActivity       DateTime?
  
  // Metadata
  source      String?   @default("manual") // manual, import, api, form
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Foreign Keys
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relazioni
  emailLogs   EmailLog[]
  listContacts ListContact[]
  automationRuns AutomationRun[]

  // Indici
  @@unique([email, userId])
  @@index([userId, status])
  @@index([email])
  @@index([tags])
  @@map("contacts")
}

enum ContactStatus {
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
  BLOCKED
  PENDING_CONFIRMATION
}

// ===========================================
// LIST MODEL - Liste di contatti
// ===========================================

model ContactList {
  id          String   @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Foreign Keys
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relazioni
  contacts    ListContact[]
  campaigns   Campaign[]

  @@index([userId])
  @@map("contact_lists")
}

// ===========================================
// LIST-CONTACT JUNCTION - Many-to-Many
// ===========================================

model ListContact {
  id        String   @id @default(cuid())
  addedAt   DateTime @default(now())

  // Foreign Keys
  listId    String
  contactId String
  list      ContactList @relation(fields: [listId], references: [id], onDelete: Cascade)
  contact   Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([listId, contactId])
  @@map("list_contacts")
}

// ===========================================
// TEMPLATE MODEL - Template email
// ===========================================

model Template {
  id          String       @id @default(cuid())
  name        String
  subject     String
  content     String
  type        TemplateType @default(CUSTOM)
  category    String?      @default("general")
  thumbnail   String?
  isPublic    Boolean      @default(false)
  variables   String       @default("[]")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Foreign Keys
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relazioni
  campaigns   Campaign[]
  automations Automation[]

  @@index([userId, type])
  @@index([category])
  @@map("templates")
}

enum TemplateType {
  NEWSLETTER
  PROMOTIONAL
  TRANSACTIONAL
  WELCOME
  FOLLOW_UP
  CUSTOM
}

// ===========================================
// CAMPAIGN MODEL - Campagne email
// ===========================================

model Campaign {
  id            String         @id @default(cuid())
  name          String
  subject       String
  content       String
  preheader     String?
  fromName      String?
  fromEmail     String?
  replyTo       String?
  
  // Configurazioni
  status        CampaignStatus @default(DRAFT)
  type          CampaignType   @default(REGULAR)
  priority      Priority       @default(NORMAL)
  
  // Scheduling
  scheduledAt   DateTime?
  sentAt        DateTime?
  completedAt   DateTime?
  
  // Statistiche (calcolate in tempo reale dai logs)
  totalRecipients    Int @default(0)
  totalSent         Int @default(0)
  totalDelivered    Int @default(0)
  totalOpened       Int @default(0)
  totalClicked      Int @default(0)
  totalBounced      Int @default(0)
  totalUnsubscribed Int @default(0)
  
  // Configurazioni avanzate
  trackOpens    Boolean @default(true)
  trackClicks   Boolean @default(true)
  enableAnalytics Boolean @default(true)
  
  // A/B Testing
  isAbTest      Boolean @default(false)
  abTestWinner  String? // ID della variante vincente
  
  // Metadata
  tags          String   @default("[]")
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Foreign Keys
  userId        String
  templateId    String?
  listId        String?
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  template      Template?    @relation(fields: [templateId], references: [id], onDelete: SetNull)
  contactList   ContactList? @relation(fields: [listId], references: [id], onDelete: SetNull)

  // Relazioni
  emailLogs     EmailLog[]
  campaignEvents CampaignEvent[]
  abVariants    AbTestVariant[]

  @@index([userId, status])
  @@index([scheduledAt])
  @@index([sentAt])
  @@index([status])
  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
  FAILED
}

enum CampaignType {
  REGULAR
  AUTOMATED
  TRIGGERED
  DRIP_SEQUENCE
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ===========================================
// A/B TEST VARIANT MODEL
// ===========================================

model AbTestVariant {
  id           String   @id @default(cuid())
  name         String   // "Variant A", "Variant B", etc.
  subject      String
  content      String
  percentage   Int      @default(50) // % di traffico per questa variante
  
  // Statistiche
  sent         Int      @default(0)
  opened       Int      @default(0)
  clicked      Int      @default(0)
  
  isWinner     Boolean  @default(false)
  createdAt    DateTime @default(now())

  // Foreign Keys
  campaignId   String
  campaign     Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("ab_test_variants")
}

// ===========================================
// EMAIL LOG MODEL - Log invii email
// ===========================================

model EmailLog {
  id            String      @id @default(cuid())
  messageId     String?     @unique // ID del provider email
  status        EmailStatus
  
  // Tracking
  sentAt        DateTime    @default(now())
  deliveredAt   DateTime?
  openedAt      DateTime?
  firstOpenedAt DateTime?
  clickedAt     DateTime?
  firstClickedAt DateTime?
  unsubscribedAt DateTime?
  bouncedAt     DateTime?
  complainedAt  DateTime?
  
  // Contatori
  openCount     Int         @default(0)
  clickCount    Int         @default(0)
  
  // Dettagli errori/bounce
  bounceType    String?     // hard, soft
  bounceReason  String?
  errorMessage  String?
  
  // Tracking dati
  userAgent     String?
  ipAddress     String?
  location      String?     // citt√†, paese
  device        String?     // desktop, mobile, tablet
  
  // Metadata
  abVariant     String?     // Se parte di A/B test
  customData    String?     @default("{}")

  // Foreign Keys
  campaignId    String
  contactId     String
  campaign      Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact       Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Relazioni
  clickEvents   ClickEvent[]

  @@index([campaignId])
  @@index([contactId])
  @@index([status])
  @@index([sentAt])
  @@index([openedAt])
  @@map("email_logs")
}

enum EmailStatus {
  QUEUED
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  FAILED
  REJECTED
  DEFERRED
  COMPLAINED
  UNSUBSCRIBED
}

// ===========================================
// CLICK EVENT MODEL - Tracking click dettagliati
// ===========================================

model ClickEvent {
  id          String   @id @default(cuid())
  url         String
  linkText    String?
  position    Int?     // Posizione del link nell'email
  clickedAt   DateTime @default(now())
  
  // Tracking info
  userAgent   String?
  ipAddress   String?
  location    String?

  // Foreign Keys
  emailLogId  String
  emailLog    EmailLog @relation(fields: [emailLogId], references: [id], onDelete: Cascade)

  @@index([emailLogId])
  @@index([url])
  @@map("click_events")
}

// ===========================================
// CAMPAIGN EVENT MODEL - Log eventi campagne
// ===========================================

model CampaignEvent {
  id          String   @id @default(cuid())
  event       String   // started, paused, completed, failed, etc.
  description String?
  data        String?  @default("{}")
  timestamp   DateTime @default(now())

  // Foreign Keys
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([event])
  @@map("campaign_events")
}

// ===========================================
// AUTOMATION MODEL - Email automation
// ===========================================

model Automation {
  id          String           @id @default(cuid())
  name        String
  description String?
  isActive    Boolean          @default(false)
  trigger     AutomationTrigger
  triggerData String?            @default("{}")
  
  // Timing
  delay       Int?             @default(0) // minuti di delay
  sendTime    String?          // "09:00" formato HH:MM
  timezone    String?          @default("Europe/Rome")
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Foreign Keys
  userId      String
  templateId  String?
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  template    Template?        @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // Relazioni
  steps       AutomationStep[]
  runs        AutomationRun[]

  @@index([userId, isActive])
  @@map("automations")
}

enum AutomationTrigger {
  CONTACT_ADDED
  EMAIL_OPENED
  EMAIL_CLICKED
  TIME_DELAY
  DATE_BASED
  TAG_ADDED
  CUSTOM_EVENT
}

// ===========================================
// AUTOMATION STEP MODEL
// ===========================================

model AutomationStep {
  id            String     @id @default(cuid())
  stepOrder     Int
  stepType      String     // email, delay, condition, action
  configuration String     @default("{}")
  isActive      Boolean    @default(true)

  // Foreign Keys
  automationId  String
  automation    Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId, stepOrder])
  @@map("automation_steps")
}

// ===========================================
// AUTOMATION RUN MODEL - Esecuzioni automation
// ===========================================

model AutomationRun {
  id            String            @id @default(cuid())
  status        AutomationStatus  @default(RUNNING)
  currentStep   Int               @default(1)
  startedAt     DateTime          @default(now())
  completedAt   DateTime?
  errorMessage  String?

  // Foreign Keys
  automationId  String
  contactId     String
  automation    Automation        @relation(fields: [automationId], references: [id], onDelete: Cascade)
  contact       Contact           @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@index([contactId])
  @@map("automation_runs")
}

enum AutomationStatus {
  RUNNING
  COMPLETED
  PAUSED
  FAILED
  CANCELLED
}

// ===========================================
// WEBHOOK MODEL - Webhook configurazioni
// ===========================================

model Webhook {
  id          String        @id @default(cuid())
  name        String
  url         String
  events      String      @default("[]")  // eventi da ascoltare come JSON string
  isActive    Boolean     @default(true)
  secret      String?     // per validazione signature
  headers     String?     @default("{}")
  retryCount  Int           @default(3)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Foreign Keys
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relazioni
  deliveries  WebhookDelivery[]

  @@index([userId])
  @@map("webhooks")
}

// ===========================================
// WEBHOOK DELIVERY MODEL - Log webhook
// ===========================================

model WebhookDelivery {
  id           String   @id @default(cuid())
  event        String
  payload      String   @default("{}")
  responseCode Int?
  responseBody String?
  attempts     Int      @default(1)
  deliveredAt  DateTime?
  failedAt     DateTime?
  nextRetryAt  DateTime?
  createdAt    DateTime @default(now())

  // Foreign Keys
  webhookId    String
  webhook      Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([event])
  @@map("webhook_deliveries")
}

// ===========================================
// SYSTEM SETTINGS MODEL
// ===========================================

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  type        String   @default("string") // string, number, boolean, json
  description String?
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

// ===========================================
// API KEY MODEL - Per integrazioni esterne
// ===========================================

model ApiKey {
  id          String   @id @default(cuid())
  name        String
  keyHash     String   @unique
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  permissions String   @default("[]")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Foreign Keys
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("api_keys")
}